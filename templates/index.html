<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jemie the Metro Agent</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,"/>
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
  <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
        href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <!-- Markdown + XSS 防護 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    /* ===== 色票集中管理 ===== */
    :root{
      --bg: #ffffff;
      --ink: #111318;           /* 主文字 */
      --muted: #637088;         /* 次要文字 */
      --border: #e6e9ef;        /* 邊界線 */
      --surface: #f5f7fa;       /* 輸入框等淺底 */
      --bubble-agent: #f3f5f7;  /* 助理泡泡 */
      --primary: #1656ce;       /* 使用者泡泡/按鈕 */
      --primary-dark: #0f47c1;  /* 按鈕 hover */
    }

    body{ background: var(--bg); color: var(--ink); }

    #chat-container { flex: 1 1 0%; overflow-y: auto; }

    /* 讓 Markdown 內容在泡泡內剛好收邊 */
    .chat-md { word-break: break-word; }
    .chat-md > :first-child { margin-top: 0; }
    .chat-md > :last-child  { margin-bottom: 0; }

    .chat-md p { margin: 0.5rem 0; }
    .chat-md ul, .chat-md ol { margin: 0.5rem 0; padding-left: 1.25rem; }
    .chat-md li { margin: 0.25rem 0; }

    .chat-md pre {
      margin: 0.5rem 0;
      padding: 0.75rem;
      background: #eef2f7;
      border-radius: 0.5rem;
      overflow-x: auto;
    }
    .chat-md code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    /* 淡淡的泡泡陰影（不浮誇） */
    .shadow-bubble { box-shadow: 0 8px 24px rgba(17,19,24,0.06); }
  </style>
</head>

<body style='font-family: "Plus Jakarta Sans","Noto Sans",sans-serif;'>
  <div class="relative flex size-full min-h-screen flex-col bg-white justify-between group/design-root overflow-x-hidden">

    <div class="flex flex-col flex-1 h-full">

      <div class="flex items-center bg-white p-4 pb-2 justify-between border-b border-[var(--border)] relative">
        <div class="text-[var(--ink)] flex size-12 shrink-0 items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path></svg>
        </div>
        <h2 id="page-title" class="text-[var(--ink)] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Jemie the Metro Agent</h2>

        <div class="absolute top-4 right-16">
          <select id="language-selector" class="form-select text-sm rounded-md border-[var(--border)] shadow-sm focus:border-[var(--primary)] focus:ring focus:ring-[var(--primary)]">
            <option value="zh-Hant">繁體中文</option>
            <option value="en">English</option>
            <option value="ja">日本語</option>
          </select>
        </div>

        <div class="flex w-12 items-center justify-end">
          <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 bg-transparent text-[var(--ink)] gap-2 text-base font-bold p-0">
            <div class="text-[var(--ink)]" data-icon="List" data-size="24px">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path></svg>
            </div>
          </button>
        </div>
      </div>

      <div id="chat-container">
        <!-- 初始系統訊息（頂端對齊 + 修正 Unsplash 參數） -->
        <div class="flex items-start gap-3 p-4">
          <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0"
               style='background-image: url("https://images.unsplash.com/photo-1639747525393-216a2d06633e?q=80&w=2787&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D");'></div>
          <div class="flex flex-1 flex-col gap-1 items-start">
            <p class="text-[var(--muted)] text-[13px] font-normal">Jemie</p>
            <div id="initial-greeting" class="text-base font-normal max-w-[360px] rounded-xl px-4 py-3 bg-[var(--bubble-agent)] text-[var(--ink)] leading-relaxed shadow-bubble">
              你好！我是你的捷運好夥伴「捷米」，準備好一起探索台北了嗎？
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white border-t border-[var(--border)]">
      <div class="flex items-center px-4 py-3 gap-3">
        <label class="flex flex-col min-w-40 h-12 flex-1">
          <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
            <input
              id="message-input"
              placeholder="輸入訊息..."
              class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[var(--ink)] focus:outline-0 focus:ring-0 border-none bg-[var(--surface)] focus:border-none h-full placeholder:text-[var(--muted)] px-4 rounded-r-none border-r-0 pr-2 text-base font-normal"
            />
            <div class="flex border-none bg-[var(--surface)] items-center justify-center pr-4 rounded-r-xl border-l-0 !pr-2">
              <div class="flex items-center gap-4 justify-end">
                <button id="send-button" class="min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-8 px-4 bg-[var(--primary)] hover:bg-[var(--primary-dark)] transition text-white text-sm font-medium">
                  <span class="truncate">傳送</span>
                </button>
              </div>
            </div>
          </div>
        </label>
      </div>
      <div class="h-5 bg-white"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatContainer   = document.getElementById('chat-container');
      const messageInput    = document.getElementById('message-input');
      const sendButton      = document.getElementById('send-button');
      const languageSelector= document.getElementById('language-selector');

      let chatHistory = [];

      const translations = {
        'zh-Hant': {
          title: '捷米 - 捷運 AI 助理',
          pageTitle: '捷米 - 捷運 AI 助理',
          initialGreeting: '你好！我是你的捷運好夥伴「捷米」，準備好一起探索台北了嗎？',
          inputPlaceholder: '輸入訊息...',
          sendButton: '傳送',
          typingIndicator: '捷米輸入中...',
          errorMessage: '唉呀！我好像斷線了，請再試一次。'
        },
        'en': {
          title: 'Jemie - Metro AI Agent',
          pageTitle: 'Jemie - Metro AI Agent',
          initialGreeting: 'Hi! I\'m Jemie, your friendly metro partner. Ready to explore Taipei?',
          inputPlaceholder: 'Type a message...',
          sendButton: 'Send',
          typingIndicator: 'Jemie is typing...',
          errorMessage: 'Oops! It seems I\'m disconnected. Please try again.'
        },
        'ja': {
          title: 'ジェミー - メトロAIアシスタント',
          pageTitle: 'ジェミー - メトロAIアシスタント',
          initialGreeting: 'こんにちは！あなたのメトロパートナー「ジェミー」です。一緒に台北を探索する準備はいいですか？',
          inputPlaceholder: 'メッセージを入力...',
          sendButton: '送信',
          typingIndicator: 'ジェミーが入力中...',
          errorMessage: 'おっと！接続が切れたようです。もう一度お試しください。'
        }
      };

      function switchLanguage(lang) {
        const t = translations[lang] || translations['zh-Hant'];
        document.title = t.title;

        const pageTitleEl = document.getElementById('page-title');
        if (pageTitleEl) pageTitleEl.textContent = t.pageTitle;

        const initialGreetingEl = document.getElementById('initial-greeting');
        if (initialGreetingEl) initialGreetingEl.textContent = t.initialGreeting;

        if (messageInput) messageInput.placeholder = t.inputPlaceholder;
        const sendButtonSpan = sendButton ? sendButton.querySelector('span') : null;
        if (sendButtonSpan) sendButtonSpan.textContent = t.sendButton;
      }

      languageSelector.addEventListener('change', (event) => {
        switchLanguage(event.target.value);
      });
      switchLanguage(languageSelector.value);

      sendButton.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          sendMessage();
        }
      });

      async function sendMessage() {
        const messageText = messageInput.value.trim();
        if (messageText === '') return;

        appendUserMessage(messageText);
        messageInput.value = '';
        messageInput.focus();

        const selectedLanguage = languageSelector.value;
        const typingIndicator = appendTypingIndicator(selectedLanguage);

        try {
          const response = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              message: messageText,
              chat_history: chatHistory,
              language: selectedLanguage
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          chatHistory = data.chat_history;

          if (typingIndicator && typingIndicator.parentNode) {
            chatContainer.removeChild(typingIndicator);
          }
          appendAgentMessage(data.response);
        } catch (error) {
          if (typingIndicator && typingIndicator.parentNode) {
            chatContainer.removeChild(typingIndicator);
          }
          const t = translations[selectedLanguage] || translations['zh-Hant'];
          appendAgentMessage(t.errorMessage);
          console.error('Error fetching chat response:', error);
        }
      }

      function appendUserMessage(text) {
        const userAvatar = `https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?q=80&w=2960&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D`;
        // 保留 XSS 防護；只把換行轉成 <br>，其他維持純文字外觀
        const safe = DOMPurify.sanitize(text).replace(/\n/g, '<br>');

        const messageHtml = `
            <div class="flex items-end gap-3 p-4 justify-end">
            <div class="flex flex-1 flex-col gap-1 items-end">
                <!-- ✅ 原本的 <p> + flex 泡泡樣式，但換用色票與陰影 -->
                <p class="text-base font-normal flex max-w-[360px] rounded-xl px-4 py-3 bg-[var(--primary)] text-white leading-relaxed shadow-bubble">${safe}</p>
            </div>
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0"
                style='background-image: url("${userAvatar}");'></div>
            </div>`;
        chatContainer.insertAdjacentHTML('beforeend', messageHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        }


      function appendAgentMessage(text) {
        const agentAvatar = `https://images.unsplash.com/photo-1639747525393-216a2d06633e?q=80&w=2787&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D`;
        const formattedHTML = DOMPurify.sanitize(marked.parse(text, { breaks: true }));

        const messageHtml = `
          <div class="flex items-start gap-3 p-4">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0"
                 style='background-image: url("${agentAvatar}");'></div>
            <div class="flex flex-1 flex-col gap-1 items-start">
              <p class="text-[var(--muted)] text-[13px] font-normal">Jemie</p>
              <div class="text-base font-normal max-w-[360px] rounded-xl px-4 py-3 bg-[var(--bubble-agent)] text-[var(--ink)] leading-relaxed shadow-bubble">
                <div class="chat-md">${formattedHTML}</div>
              </div>
            </div>
          </div>`;
        chatContainer.insertAdjacentHTML('beforeend', messageHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function appendTypingIndicator(lang) {
        const t = translations[lang] || translations['zh-Hant'];
        const agentAvatar = `https://images.unsplash.com/photo-1639747525393-216a2d06633e?q=80&w=2787&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D`;
        const typingHtml = `
          <div class="flex items-start gap-3 p-4" id="typing-indicator">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0"
                 style='background-image: url("${agentAvatar}");'></div>
            <div class="flex flex-1 flex-col gap-1 items-start">
              <div class="text-base font-normal max-w-[360px] rounded-xl px-4 py-3 bg-[var(--bubble-agent)] text-[var(--muted)] leading-relaxed shadow-bubble">
                ${t.typingIndicator}
              </div>
            </div>
          </div>`;
        chatContainer.insertAdjacentHTML('beforeend', typingHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return document.getElementById('typing-indicator');
      }
    });
  </script>
</body>
</html>
